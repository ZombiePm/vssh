#!/bin/bash
# vssh — SSH wrapper that fetches private keys from HashiCorp Vault
# Keys are loaded into ssh-agent memory and never written to disk.
# On Windows, keys are also automatically added to Pageant (PuTTY agent).
#
# Usage: vssh <host-alias> [extra ssh args...]
#
# All configuration lives in ~/.ssh/config:
#   Global (top of file):
#     # vssh:vault_addr https://vault.example.com
#     # vssh:default_vault_key secret/ssh/default-key
#   Per-host (inside Host block):
#     # vssh:vault_path secret/ssh/some-key

set -e

SSH_CONFIG="$HOME/.ssh/config"

# Read global vssh settings from SSH config (tr -d '\r' handles CRLF on Windows)
VAULT_ADDR="${VAULT_ADDR:-$(tr -d '\r' < "$SSH_CONFIG" | grep -m1 '^# vssh:vault_addr ' | awk '{print $3}')}"
DEFAULT_VAULT_KEY=$(tr -d '\r' < "$SSH_CONFIG" | grep -m1 '^# vssh:default_vault_key ' | awk '{print $3}')
export VAULT_ADDR

if [ -z "$VAULT_ADDR" ]; then
    echo "Error: VAULT_ADDR is not set"
    echo "Set it via environment variable or add '# vssh:vault_addr <url>' to $SSH_CONFIG"
    exit 1
fi

if [ -z "$1" ]; then
    echo "Usage: vssh <host> [ssh args...]"
    echo ""
    echo "Available hosts:"
    grep "^Host " "$SSH_CONFIG" | awk '{print "  " $2}'
    exit 1
fi

HOST="$1"
shift

# Extract per-host vssh:vault_path from SSH config
get_host_vault_path() {
    local host="$1" in_host=0
    while IFS= read -r line; do
        if [[ "$line" =~ ^Host[[:space:]]+(.*) ]]; then
            local hosts="${BASH_REMATCH[1]}"
            in_host=0
            for h in $hosts; do
                [[ "$h" == "$host" ]] && in_host=1
            done
        elif [[ $in_host -eq 1 && "$line" =~ ^[[:space:]]*#[[:space:]]*vssh:vault_path[[:space:]]+(.*) ]]; then
            echo "${BASH_REMATCH[1]}"
            return 0
        fi
    done < <(tr -d '\r' < "$SSH_CONFIG")
    return 1
}

# Add key to Pageant via SSH agent protocol (no temp files, no puttygen)
VSSH_DIR="$(cd "$(dirname "$0")" && pwd)"
add_to_pageant() {
    local key_data="$1"
    if ! printf '%s\n' "$key_data" | python "$VSSH_DIR/vssh-pageant.py" 2>/dev/null; then
        echo "Warning: Failed to add key to Pageant"
        return 1
    fi
}

# Collect all unique vault paths from SSH config
get_all_vault_paths() {
    local paths=()
    local in_host=0 current_path=""
    while IFS= read -r line; do
        if [[ "$line" =~ ^Host[[:space:]] ]]; then
            in_host=1
            current_path=""
        elif [[ $in_host -eq 1 && "$line" =~ ^[[:space:]]*#[[:space:]]*vssh:vault_path[[:space:]]+(.*) ]]; then
            current_path="${BASH_REMATCH[1]}"
            # Add if not already in list
            local found=0
            for p in "${paths[@]}"; do [[ "$p" == "$current_path" ]] && found=1; done
            [[ $found -eq 0 ]] && paths+=("$current_path")
        fi
    done < <(tr -d '\r' < "$SSH_CONFIG")
    # Add default key if set and not already listed
    if [ -n "$DEFAULT_VAULT_KEY" ]; then
        local found=0
        for p in "${paths[@]}"; do [[ "$p" == "$DEFAULT_VAULT_KEY" ]] && found=1; done
        [[ $found -eq 0 ]] && paths+=("$DEFAULT_VAULT_KEY")
    fi
    printf '%s\n' "${paths[@]}"
}

# Load all SSH keys into Pageant
load_all_pageant_keys() {
    local paths
    mapfile -t paths < <(get_all_vault_paths)
    if [ ${#paths[@]} -eq 0 ]; then return; fi
    echo "Loading all keys into Pageant..."
    for vp in "${paths[@]}"; do
        local kd
        kd=$(vault kv get -field=private_key "$vp" 2>/dev/null) || { echo "  Warning: Failed to fetch $vp"; continue; }
        printf '%s\n' "$kd" | python "$VSSH_DIR/vssh-pageant.py" "$vp" 2>/dev/null
    done
}

VAULT_PATH=$(get_host_vault_path "$HOST") || VAULT_PATH="$DEFAULT_VAULT_KEY"

if [ -z "$VAULT_PATH" ]; then
    echo "Error: No vault path for host '$HOST' and no default_vault_key set"
    echo "Add '# vssh:vault_path <path>' to the Host block or '# vssh:default_vault_key <path>' at the top of $SSH_CONFIG"
    exit 1
fi

echo "Fetching key from Vault: $VAULT_PATH"

# Start a temporary ssh-agent (key stays in RAM only)
eval "$(ssh-agent -s)" > /dev/null

# Cleanup: kill the temporary agent on exit
cleanup() {
    ssh-agent -k > /dev/null 2>&1
}
trap cleanup EXIT

# Fetch key from Vault into memory
KEY_DATA=$(vault kv get -field=private_key "$VAULT_PATH" 2>/dev/null) || {
    echo "Error: Failed to fetch key from Vault path '$VAULT_PATH'"
    echo "Make sure you are logged in: vault login"
    exit 1
}

# Load key into ssh-agent via pipe (never touches disk for ssh-agent)
printf '%s\n' "$KEY_DATA" | ssh-add - 2>/dev/null || {
    echo "Error: Failed to add key to ssh-agent"
    exit 1
}

# Add all keys to Pageant (PuTTY agent) — keys persist in Pageant after vssh exits
load_all_pageant_keys || true

# Clear key from shell memory
unset KEY_DATA

echo "Connecting to $HOST..."

# Run SSH — the agent provides the key, no files needed
ssh -o StrictHostKeyChecking=accept-new \
    "$HOST" "$@"
